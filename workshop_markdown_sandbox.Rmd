---
title: "SEISMIC Collaborative LAK Workshop"
author: "V.Farrar"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
syndat <- read.csv(file = "~/Downloads/LAK-workshop-materials/sim_data_v.2.csv")

#renaming variables MV synthetic data
syndat$crs_name <- syndat$course
syndat$ethniccode_cat <- syndat$ethnicity
syndat$firstgen <- syndat$first_gen
syndat$lowincomeflag <- syndat$lowincome
syndat$numgrade <- syndat$grade

#load packages
  #ISSUE: change to pacman to reduce number of installations needed.
library(tidyverse)
library(gmodels)
```

# Define Your Course of Interest

What course are you interested in looking at? Options: BIO300, MATH100

Define it below, in quotes "", in the code below. This will be used in the rest of the code, and you can always come back and change it.

```{r course of interest}
#options: "Entry Bio", "Lower Chem", "Upper Bio"
course_of_interest <- "Entry Bio"
```

# Systemic Advantage Index

## Calculating SAI

SAI, or systemic advantage index, is a metric that takes into account multiple axes of student identities, including:

-   race/ethnicity

-   gender

-   socioeconomic status

-   parental education (i.e., first-generation college-going status)

💭 Can you think of any other systemic advantages not included in this index that likely influence student's outcomes in a course? What would be the challenges to adding those identities or advantages to this index?

➡️ **Your task: Walk through one of the lines of code and compare it with the SAI table below from the talk. Can you explain where the SAI assignment comes from?**

```{r SAI calculation, echo=TRUE}
#this code goes through all possible combinations of the 4 advantage axes and assigns an SAI based on that students' values
#as ethniccode_cat == 1 is the "BIPOC" label, all other categories are considered advantaged 
syndat <-
  syndat %>% mutate(sai = case_when(
    female == "0" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "0"  ~ "4",
    female == "1" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "0"  ~ "3",
    female == "0" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "0"  ~ "3", 
    female == "0" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "1"  ~ "3", 
    female == "0" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "0"  ~ "3", 
    female == "0" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "0"  ~ "2", 
    female == "0" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "1"  ~ "2", 
    female == "1" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "0"  ~ "2", 
    female == "0" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "1"  ~ "2", 
    female == "1" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "0"  ~ "2", 
    female == "1" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "1"  ~ "2", 
    female == "1" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "1"  ~ "1", 
    female == "1" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "0"  ~ "1",
    female == "1" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "1"  ~ "1", 
    female == "0" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "1"  ~ "1",
    female == "1" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "1"  ~ "0",
    TRUE ~ "NA"))
```

## Exploring course outcomes across SAI

Let's explore what grade outcomes look like across levels of SAI in our course of interest.

```{r SAI summary stats, warning=FALSE, message=FALSE}
syndat %>%
  filter(crs_name == course_of_interest) %>%
  group_by(crs_name, sai) %>%
  summarise(n = n(),
            mean_grade = mean(numgrade, na.rm = T),
            sd_grade = sd(numgrade, na.rm = T))
```

```{r SAI plot}
#plot raw grades in course of interest
syndat %>%
  filter(crs_name %in% course_of_interest) %>%
  ggplot(aes(x = sai, y = numgrade, color = crs_name))+ 
      stat_summary(geom = "point", fun = "mean", 
                 position = position_dodge(0.2)) + 
    stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", 
                 width = 0.1, position = position_dodge(0.2)) +
  labs(title = paste(course_of_interest)) + 
  theme_bw()

#plot raw grades by all disciplines 
ggplot(syndat, aes(x = sai, y = numgrade, color = crs_name)) + 
    stat_summary(geom = "point", fun = "mean", 
                 position = position_dodge(0.2)) + 
    stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", 
                 width = 0.1, position = position_dodge(0.2)) +
  labs(title = "Compare All Disciplines") +
  theme_bw()
```

## SAI and Grade Anomaly

While we can see differences in raw grade outcomes across the advantages spectrum, many studies control for metrics of prior academic performance when evaluating outcomes in a course.

These are typically: high school GPA, standardized test scores (SAT/ACT), prior cumulative GPA at an institution, or GPA excluding the course of interest (GPAO).

💭 Given the talks today, what are some issues with referencing prior academic performance as a "control" for student preparation?

**Grade anomaly**, or the difference between the current course grade and a student's prior academic performance, can show us how outcomes in this course differ from student's previous experiences at the instution (or other academic settings).

```{r grade anomaly vs raw grade}
#returns 95% confidence intervals across courses and SAI for grade anomaly
syndat %>% 
  mutate(grade_anomaly = numgrade - gpao) %>%
  group_by(crs_name, sai) %>%
  summarise(mean = ci(grade_anomaly)[1], 
                      lowCI = ci(grade_anomaly)[2],
                      hiCI = ci(grade_anomaly)[3], 
                      sd = ci (grade_anomaly)[4])
```

```{r grade anomaly across SAI}
#grade anomaly across all disciplines
ggplot(syndat, aes(x = sai, y = numgrade-gpao, color = crs_name)) + 
    stat_summary(geom = "point", fun = "mean", 
                 position = position_dodge(0.2)) + 
    stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", 
                 width = 0.1, position = position_dodge(0.2)) +
  labs(title = "Compare All Disciplines", x = "SAI", 
       y = "Grade anomaly") +
  theme_bw()
```

Another way we can explore the concept of grade anomaly is by comparing the relationship between GPAO and course grades for each level of SAI.

```{r gpao vs numgrade, message=FALSE, warning=FALSE}
syndat %>%
  group_by(crs_name, sai) %>%
  summarise(mean_gpao = ci(gpao)[1], 
            lo_gpao = ci(gpao)[2],
            hi_gpao = ci(gpao)[3], 
            mean_grade = ci(numgrade)[1],
            lo_grade = ci(numgrade)[2],
            hi_grade = ci(numgrade)[3]) %>%
  ggplot(aes(x = mean_gpao, y = mean_grade, color = sai)) +
  geom_point() + 
  geom_errorbar(aes(xmin = lo_gpao, xmax = hi_gpao), 
                width = 0) + 
  geom_errorbar(aes(ymin = lo_grade, ymax = hi_grade), 
                width = 0) + 
  geom_abline(intercept = 0, slope = 1, color = "black") + 
  facet_wrap(~crs_name) +
  theme_bw()
                    
```

**Question**: Are students in the course of interest getting grades that are lower on average ("grade penalty") or higher on average ("grade bonus") compared to their other courses? Does this effect differ with the number of systemic advantages (SAI)?

# Classroom Composition

How does the number of students represented in a course relate to course outcomes for students that hold that identity in that course?

```{r create classroom structure in syndat}
#create classroom structure within synthetic dataset

#arrange data by demographic vars
syndat <- syndat %>% arrange(course,lowincome, first_gen, ethnicity, female)

#create a section variable
syndat$crs_section <- rep(c(1:2,1:3,1:4), length.out=2369)

#show percents by demographic var
syndat %>% group_by(course, crs_section) %>%
  summarise(n = n(),
            perc_women = (sum(female == "1", na.rm = T)/n)*100,
            perc_peer = (sum(ethnicity == "1", na.rm = T)/n)*100,
            perc_firstgen = (sum(first_gen == "1", na.rm = T)/n)*100)

```
Let's explore the data first: 

```{r correlations of gaps and %}
#show percents by demographic var
syndat %>% group_by(course, crs_section) %>%
  summarise(n = n(),
            mean_gender_gap = mean(numgrade[female =="1"]) - mean(numgrade[female == "0"]), 
            perc_women = (sum(female == "1", na.rm = T)/n)*100,
            perc_peer = (sum(ethnicity == "1", na.rm = T)/n)*100,
            perc_firstgen = (sum(first_gen == "1", na.rm = T)/n)*100) %>%
  ggplot(aes(x = perc_women, y = mean_gender_gap, color = course)) +
   geom_point() + 
  geom_smooth(method = "lm") + 
  labs(x = "% Women", y = "Gender Gap in Course Grade (W-M)", 
       color = "Course") + 
  theme_bw()
  
```

